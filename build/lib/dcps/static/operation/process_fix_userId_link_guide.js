function process_replace_words() {var code="#&nbsp;encoding:&nbsp;utf-8<br>'''<br>&nbsp;&nbsp;&nbsp;&nbsp;修复数据bug,&nbsp;问题:guidetrip表中的导游数据中,&nbsp;有些userId在User表中不存在<br>&nbsp;&nbsp;&nbsp;&nbsp;即guidetrip::userId&nbsp;not&nbsp;in&nbsp;set(user::_id)<br>&nbsp;&nbsp;&nbsp;&nbsp;process流程:&nbsp;建立user::_id的集合set,<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将原来的status=0的都添加字段'oldStatus&nbsp;=&nbsp;0'<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于所有&nbsp;guidetrip::userId中满足条件:productType{'$in':[1,2,3,4]}&nbsp;且&nbsp;crawled==True的,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;in&nbsp;set:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;随便选个已存在的id替换?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;0<br><br>'''<br><br>import&nbsp;pymongo<br>from&nbsp;util&nbsp;import&nbsp;mongo_util<br><br>guide_client&nbsp;=&nbsp;mongo_util.get_mongo_client('mongodb://0.0.0.0:27017/',db='matafy')<br>guide_col&nbsp;=&nbsp;guide_client.guidetrip<br><br>users_client&nbsp;=&nbsp;mongo_util.get_mongo_client(db='sso')<br>users_col&nbsp;=&nbsp;users_client.users<br>#&nbsp;#&nbsp;先对老的status==0的document进行标注,&nbsp;方便以后查询<br>#&nbsp;countOfStatus&nbsp;=&nbsp;0<br>#&nbsp;for&nbsp;j&nbsp;in&nbsp;guide_col.find({'status':&nbsp;0}):<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;countOfStatus&nbsp;+=&nbsp;1<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;'countOfStatus:&nbsp;'&nbsp;+&nbsp;str(countOfStatus)<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idOfOldStatus&nbsp;=&nbsp;j.get('_id')<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;guide_col.update_one(<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{'_id':&nbsp;idOfOldStatus},<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'$set':&nbsp;{<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'oldStatus':&nbsp;0<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;result.modified_count:<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;'modify&nbsp;oldStatus==0&nbsp;success'<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;for&nbsp;i&nbsp;in&nbsp;guide_col.find({'_id':idOfOldStatus}):<br>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;i.get('_id')<br><br><br><br><br><br>count&nbsp;=&nbsp;0<br>#&nbsp;建立User表的id的集合<br>users_id&nbsp;=&nbsp;set()<br>for&nbsp;i&nbsp;in&nbsp;users_col.find():<br>&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;=&nbsp;i.get('_id')<br>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;print&nbsp;type(str(id))<br>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;print&nbsp;'id:&nbsp;'&nbsp;+&nbsp;str(id)<br>&nbsp;&nbsp;&nbsp;&nbsp;users_id.add(str(id))<br>#&nbsp;print&nbsp;'ids&nbsp;count:&nbsp;'&nbsp;+&nbsp;str(len(users_id))<br>userId_count&nbsp;=&nbsp;0<br>#&nbsp;进行查找且更新<br>for&nbsp;j&nbsp;in&nbsp;guide_col.find({'crawled':&nbsp;True,&nbsp;'status':&nbsp;1}):<br>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;userId_count&nbsp;+=&nbsp;1<br>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;要修改的是guidetrip中的document,&nbsp;因此取_id<br>&nbsp;&nbsp;&nbsp;&nbsp;userIdObj&nbsp;=&nbsp;j.get('_id')<br>&nbsp;&nbsp;&nbsp;&nbsp;userId&nbsp;=&nbsp;str(j.get('userId'))<br>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;userId&nbsp;in&nbsp;users_id:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userId_count&nbsp;+=&nbsp;1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;userId_count<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;进行更新,&nbsp;将status设为0,&nbsp;且OldStatus设为1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;#&nbsp;result&nbsp;=&nbsp;guide_col.update_one(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{'_id':&nbsp;userIdObj},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'$set':&nbsp;{'oldStatus':&nbsp;1,&nbsp;'status':&nbsp;0}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;#&nbsp;)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;if&nbsp;result.modified_count:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;'modefied&nbsp;success,&nbsp;_id:'&nbsp;+&nbsp;str(userId)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;else:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;userId_count<br><br>";return code;}